% LTeX: language=en-GB
%Author(s), Course variables
\newcommand{\titl}{02132 Assignment 2 report}
\newcommand{\subtitl}{Hardware implementation in Chisel\\of a small CPU running the image erosion}
\newcommand{\authone}{Mikkel Arn Andersen}
\newcommand{\SIDone}{s224187}
\newcommand{\authtwo}{Niclas Juul Schæffer}
\newcommand{\SIDtwo}{s224744}
\newcommand{\auththree}{Rasmus Kronborg Finnemann Wiuff}
\newcommand{\SIDthree}{s163977}
\newcommand{\lb}{\\}
%Basics
\documentclass[a4paper, english]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[bitstream-charter]{mathdesign}
\usepackage{babel}
\usepackage[moderate, mathspacing=normal]{savetrees}
%Symbols and scientifics
\usepackage{bm}
\usepackage{physics}
\usepackage{mathtools}
\numberwithin{equation}{section}
\usepackage{siunitx}
\sisetup{
per-mode = power ,
round-mode = figures ,
round-precision = 3 ,
exponent-mode = input ,
output-decimal-marker = {.} ,
exponent-product = 	imes ,
uncertainty-mode = separate ,
range-phrase = - ,
range-units =  single ,
inter-unit-product = \ensuremath{{\cdot{}}} ,
quantity-product = \ ,
separate-uncertainty-units = single ,
}

%Appendix, TOC and Bibliography
\usepackage{appendix}
\renewcommand\appendixtocname{Appendix}
\usepackage[nottoc]{tocbibind}
\setcounter{tocdepth}{2}
\usepackage{lastpage}

%Figures
\usepackage[svgnames]{xcolor} % Required to specify font color
\usepackage{float}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage[format=plain,
    labelfont={bf,it,footnotesize},
    textfont={it,footnotesize}]{caption}
% \captionsetup[table]{name=Huskeord}
\captionsetup{font={stretch=0.9}}
\usepackage{wrapfig}
\usepackage[a4paper, centering, rmargin=2.5cm, tmargin=2.5cm, lmargin=2.5cm, bmargin=3.5cm]{geometry}
\usepackage{verbatim}
\usepackage[space]{grffile}
\usepackage[final]{pdfpages}
\usepackage{multirow}
\usepackage{fontawesome}
\usepackage{tikz}
\usetikzlibrary{positioning}

%Header footer
\usepackage{fancyhdr}
\pagestyle{fancy}
\lhead{02132 Computer Systems \lb Assignment 1 \lb November \nth{5}}
\chead{\includegraphics[width=.05\textwidth]{DTU}}
\rhead{\authone \ \textbf{\SIDone} \lb \authtwo \ \textbf{\SIDtwo} \lb \auththree \ \textbf{\SIDthree}}
\cfoot{Page \thepage\, of\, \pageref*{LastPage}}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}
\setlength{\headheight}{36.75034pt}

%Text tools
\usepackage{listings}
\usepackage{parcolumns}
\usepackage[super]{nth}
\usepackage[normalem]{ulem}
\usepackage{import}
\usepackage{url}
\usepackage{lipsum}
\usepackage{microtype}
\usepackage[pdfencoding=auto, psdextra]{hyperref}
\hypersetup{
    colorlinks   = true, %Colours links instead of ugly boxes
    urlcolor     = blue, %Colour for external hyperlinks
    linkcolor    = blue, %Colour of internal links
    citecolor   = red %Colour of citations
}
\usepackage[capitalise]{cleveref}
% \crefname{table}{Huskeord}{Huskeord}
\usepackage{enumitem}
\newlist{arrowlist}{itemize}{1}
\setlist[arrowlist]{label={\(\rightarrow\)}}
\usepackage{tabularray}
\UseTblrLibrary{booktabs}
\usepackage{todonotes}
\usepackage[square, longnamesfirst, numbers]{natbib}
\usepackage{empheq}
% \usepackage[newfloat, outputdir=../]{minted} % Overleaf minted buildpath fix
\usepackage[newfloat]{minted}
\setminted{fontsize=\small,
           linenos=true}
\usemintedstyle{tango}
\SetupFloatingEnvironment{listing}{listname=Listings}
\captionsetup[listing]{position=top, skip=-1pt}
\newcommand{\im}[3]{\inputminted[linenos=true, python3=true, firstline=#2, lastline=#3]{python}{#1}}
\newcommand{\java}[3]{\inputminted[linenos=true, firstline=#2, lastline=#3]{java}{#1}}
\usepackage{dirtree}

%Definitions and new commands
\newcommand{\degr}{^{\circ}}
\newcommand{\me}{\mathrm{e}}

%Title and sectioning
\def\Vhrulefill{\leavevmode\leaders\hrule height 0.7ex depth \dimexpr0.4pt-0.7ex\hfill\kern0pt}
\usepackage{titlesec}
\usepackage{titling}
\definecolor{DTUred}{cmyk}{0, .91, .72, .23}
\definecolor{FMNgrey}{cmyk}{.73,.43,.53,.38}
%Use letters insted of numbers in section numbering
% \renewcommand{\thesection}{\Alph{section}}
% \renewcommand{\thesubsection}{\Alph{subsection}}

\makeatletter
\newcommand{\github}[1]{%
   \href{#1}{\color{DTUred}\faGithub}%
}
\makeatother

%Algorithms and pseudocode
\newcounter{nalg}[section] % defines algorithm counter for chapter-level
\renewcommand{\thenalg}{\thesection .\arabic{nalg}} %defines appearance of the algorithm counter
\DeclareCaptionLabelFormat{algocaption}{Algoritme \thenalg} % defines a new caption label as Algorithm x.y

\lstnewenvironment{algorithm}[1][] %defines the algorithm listing environment
{
    \refstepcounter{nalg} %increments algorithm number
    \captionsetup{labelformat=algocaption,labelsep=colon} %defines the caption setup for: it ises label format as the declared caption label above and makes label and caption text to be separated by a ':'
    \lstset{ %this is the stype
        mathescape=true,
        frame=tB,
        numbers=left,
        numberstyle=\tiny,
        basicstyle=\scriptsize,
        keywordstyle=\color{black}\bfseries\em,
        keywords={,input, output, return, datatype, function, in, if, else, foreach, for, while, begin, end, do,} %add the keywords you want, or load a language as Rubens explains in his comment above.
        numbers=left,
        xleftmargin=.04\textwidth,
        columns=fullflexible,
        escapechar=\&,
        #1 % this is to add specific settings to an usage of this environment (for instnce, the caption and referable label)
    }
}
{}
\newcommand*{\runtimeAnalysis}[3]{\hfill\makebox[#3em][l]{\(#1\)}\hspace{5em}\makebox[#3em][l]{\(#2\)}}%

\begin{document}

\titleformat{\section}[block]
{\normalfont\Large\scshape\filright\color{DTUred}}{\fbox{\thesection}}{1em}{}

\titleformat{\subsection}
{\titlerule
    \vspace{.8ex}%
    \normalfont\scshape\color{FMNgrey}}
{\thesubsection.}{.5em}{}

\titleformat{\subsubsection}[wrap]
{\normalfont\fontseries{b}\selectfont\filright}
{\thesubsubsection.}{.5em}{}
\titlespacing{\subsubsection}
{12pc}{1.5ex plus .1ex minus .2ex}{1pc}

\title{\vspace{-40mm}\Huge\scshape\color{DTUred} \titl\lb\vspace{-4mm}\rule{4cm}{0.5mm}\lb\Large{\subtitl}}
\date{November \nth{5}}
\preauthor{\begin{center}
        \large \lineskip 0.5em%
        \begin{tabular}[t]{r}}
            \author{\textbf{Group: 22} \lb \lb \authone \ \textbf{\SIDone} \lb \authtwo \ \textbf{\SIDtwo} \lb \auththree \ \textbf{\SIDthree} \lb \href{https://github.com/rwiuff/02132Assignment2}{\color{DTUred}github.com/rwiuff/02132Assignment2} \github{https://github.com/rwiuff/02132Assignment2}}
            \postauthor{\end{tabular}\par\end{center}}
\maketitle

\pagenumbering{arabic}

\thispagestyle{empty}

\section{Work distribution}
\cref{tbl:ansvar} shows the work distribution in the group for this project.
\begin{table}[H]
    \centering
    \caption{Work distribution on the project}\label{tbl:ansvar}
    \begin{tabular}{lll}
        \toprule
        Name                 & Development tasks & Report tasks   \\
        \midrule
        Mikkel Arn Andersen  &                   &                \\
        Niclas Juul Schæffer &                   &                \\
        Rasmus Wiuff         & ISA               & \cref{sec:isa} \\
        \bottomrule
    \end{tabular}
\end{table}
\section{Design}
% \emph{Explain here what the design process was. List and describe your ISA and how the instructions are encoded. List and describe your compiled program (put a reference to attached file if the compiled program is too long to fit here). Show and describe the block diagram of your CPU. Motivate the design decision you made.}
\subsection{ISA and encoding}\label{sec:isa}
The ISA instructions are inspired from Appendix A in the assignment description. It is listed in \cref{tbl:ISA}.
\begin{table}[H]
    \centering
    \caption{Instruction-set architecture used in the assignment}\label{tbl:ISA}
    \begin{tabular}{lll}
        \toprule
        \textbf{Instruction}  & \textbf{Syntax}          & \textbf{Meaning}                  \\
        \midrule
        \multicolumn{3}{c}{Arithmetic instructions}                                          \\
        \midrule
        Addition              & \texttt{ADD Rx, Ry, Rz;} & \texttt{Rx = Ry + Rz}             \\
        Subtraction           & \texttt{SUB Rx, Ry, Rz;} & \texttt{Rx = Ry - Rz}             \\
        Immediate addition    & \texttt{ADDI Rx, Ry, z;} & \texttt{Rx = Ry + z}              \\
        Immediate subtraction & \texttt{SUBI Rx, Ry, z;} & \texttt{Rx = Ry - z}              \\
        Multiplication        & \texttt{MUL Rx, Ry, Rz;} & \texttt{Rx = Ry \(\cdot\) Rz}     \\
        \midrule
        \multicolumn{3}{c}{Logic instructions}                                               \\
        \midrule
        Bitwise OR            & \texttt{OR Rx, Ry, Rz;}  & \texttt{Rx = Ry \(\vert\) Rz}     \\
        Bitwise AND           & \texttt{AND Rx, Ry, Rz;} & \texttt{Rx = Ry \(\&\) Rz}        \\
        Bitwise NOT           & \texttt{NOT Rx, Ry;}     & \texttt{Rx = \(\sim\)Ry}          \\
        \midrule
        \multicolumn{3}{c}{Memory instructions}                                              \\
        \midrule
        Load immediate        & \texttt{LI Rx, y;}       & \texttt{Rx = y}                   \\
        Load data             & \texttt{LD Rx, Ry;}      & \texttt{Rx = memory(Ry)}          \\
        Store data            & \texttt{SD Rx, Ry;}      & \texttt{memory(Ry) = Rx}          \\
        \midrule
        \multicolumn{3}{c}{Control and flow instructions}                                    \\
        \midrule
        Jump                  & \texttt{JMP x}           & \texttt{GOTO INST x}              \\
        Jump if equal         & \texttt{JEQ Rx, Ry, z;}  & \texttt{if(Rx == Ry) GOTO INST z} \\
        Jump if less than     & \texttt{JLT Rx, Ry, z;}  & \texttt{if(Rx < Ry) GOTO INST z}  \\
        Jump if greater than  & \texttt{JGT Rx, Ry, z;}  & \texttt{if(Rx > Ry) GOTO INST z}  \\
        % Jump if zero          & \texttt{JZ Rx, y;}       & \texttt{if(Rx == 0) GOTO INST y}  \\
        Do nothing            & \texttt{NOP;}            & \texttt{No operation}             \\
        END                   & \texttt{END;}            & \texttt{Terminate}                \\
        \bottomrule
    \end{tabular}
\end{table}
To design the instructions, first the bit sizes are considered. Some are given in the assignment. If there are 16 registers, these can be reached with \(\log_2{16} = 4\) bits. Values for the logic and arithmetic operations are 16 bit as well as addresses in the memory. The opcodes fit within 5 bits.\newline
The instructions have 3 types: Register type, immediate type and jump type. They are laid out as shown in \cref{fig:inst}.
\begin{figure}[H]
    \centering
    \caption{Instruction layouts.}\label{fig:inst}
    \begin{subfigure}{\textwidth}
        \centering
        \caption{Register type instruction. R1 and 2 are operands, Rd is the destination register.}\label{fig:rinst}
        \resizebox{\textwidth}{!}{%
            \begin{tikzpicture}
                \draw[black, very thick] (0,0) rectangle (32,2); % INST box
                \draw[fill=green!20] (0,0) rectangle (5,2); % OPCODE section
                \draw[fill=red!20] (5,0) rectangle (10,2); % Reg section
                \draw[fill=blue!20] (10,0) rectangle (15,2); % Reg section
                \draw[fill=yellow!20] (15,0) rectangle (20,2); % Reg section
                \draw[fill=cyan!20] (20,0) rectangle (32,2); % Value section
                \node[align=center] (opcode) at (2,1) {\Large OPCODE (5 bits) \\ \Large 27\(\cdots\)31};
                \node[align=center] (rd) at (7,1) {\Large Rd (5 bits) \\ \Large 22\(\cdots\)26};
                \node[align=center] (r1) at (12,1) {\Large R1 (5 bits) \\ \Large 17\(\cdots\)21};
                \node[align=center] (r2) at (17,1) {\Large R2 (5 bits) \\ \Large 12\(\cdots\)16};
                % \node[align=center] (val) at (18,1) {\Large Value (16 bit) \\ \Large 0\(\cdots\)15};
                % \node (zero) at (32,3) {\Large 0};
                % \node (thirtytwo) at (0,3) {\Large 31};
                % \draw[->, very thick] (zero) -- (32,2);
                % \draw[->, very thick] (thirtytwo) -- (0,2);
            \end{tikzpicture}
        }%
        \vspace{.5cm}
    \end{subfigure}
    \begin{subfigure}{\textwidth}
        \centering
        \caption{Immediate type instruction. R1 is an operand. Rd is the destination register. Value is the other operand.}\label{fig:iinst}
        \resizebox{\textwidth}{!}{%
            \begin{tikzpicture}
                \draw[black, very thick] (0,0) rectangle (32,2); % INST box
                \draw[fill=green!20] (0,0) rectangle (5,2); % OPCODE section
                \draw[fill=red!20] (5,0) rectangle (10,2); % Reg section
                \draw[fill=blue!20] (10,0) rectangle (15,2); % Reg section
                \draw[fill=yellow!20] (15,0) rectangle (31,2); % Reg section
                \draw[fill=cyan!20] (31,0) rectangle (32,2); % Value section
                \node[align=center] (opcode) at (2,1) {\Large OPCODE (5 bits) \\ \Large 27\(\cdots\)31};
                \node[align=center] (rd) at (7,1) {\Large Rd (5 bits) \\ \Large 22\(\cdots\)26};
                \node[align=center] (r1) at (12,1) {\Large R1 (5 bits) \\ \Large 17\(\cdots\)21};
                \node[align=center] (target) at (18,1) {\Large Value (16 bits) \\ \Large 1\(\cdots\)16};
                % \node (zero) at (32,3) {\Large 0};
                % \node (thirtytwo) at (0,3) {\Large 31};
                % \draw[->, very thick] (zero) -- (32,2);
                % \draw[->, very thick] (thirtytwo) -- (0,2);
            \end{tikzpicture}
        }%
        \vspace{.5cm}
    \end{subfigure}
    \begin{subfigure}{\textwidth}
        \centering
        \caption{Jump type instruction. R1 and R2 are operands. Target is the target address.}\label{fig:jinst}
        \resizebox{\textwidth}{!}{%
            \begin{tikzpicture}
                \draw[black, very thick] (0,0) rectangle (32,2); % INST box
                \draw[fill=green!20] (0,0) rectangle (5,2); % OPCODE section
                \draw[fill=red!20] (5,0) rectangle (10,2); % Reg section
                \draw[fill=blue!20] (10,0) rectangle (15,2); % Reg section
                \draw[fill=yellow!20] (15,0) rectangle (31,2); % Reg section
                \draw[fill=cyan!20] (31,0) rectangle (32,2); % Value section
                \node[align=center] (opcode) at (2,1) {\Large OPCODE (5 bits) \\ \Large 27\(\cdots\)31};
                \node[align=center] (r1) at (7,1) {\Large R1 (5 bits) \\ \Large 22\(\cdots\)26};
                \node[align=center] (r2) at (12,1) {\Large R2 (5 bits) \\ \Large 17\(\cdots\)21};
                \node[align=center] (target) at (18,1) {\Large Target (16 bits) \\ \Large 1\(\cdots\)16};
                % \node (zero) at (32,3) {\Large 0};
                % \node (thirtytwo) at (0,3) {\Large 31};
                % \draw[->, very thick] (zero) -- (32,2);
                % \draw[->, very thick] (thirtytwo) -- (0,2);
            \end{tikzpicture}
        }%
    \end{subfigure}
\end{figure}
\subsubsection{Opcodes}
As seen in \cref{fig:inst} there are 5 bits allocated to opcodes. \cref{tbl:ISA} accounts for eight register type operations, four jump types, three immediate types and two runtime operations. The encoding scheme uses significant bits to determine the type of operation. The first bit tells if the instruction is runtime or not. Second bit tells if the instruction is of register type or jump/immediate type. For the latter the third bit determines if the instruction is of jump or immediate type. The scheme is laid out in \cref{tbl:opcode}. Using bits to determine the instruction type, designing the chip decoding becomes easier.

\begin{table}[H]
    \centering
    \caption{OPCODE instruction bits.}\label{tbl:opcode}
    \begin{tabular}{lll}
        \toprule
        Instruction type           & OPCODE bits & Instruction   \\
        \midrule
        \multirow{8}{*}{Register}  & 00000       & \texttt{ADD}  \\
                                   & 00001       & \texttt{SUB}  \\
                                   & 00010       & \texttt{MUL}  \\
                                   & 00011       & \texttt{OR}   \\
                                   & 00100       & \texttt{AND}  \\
                                   & 00101       & \texttt{NOT}  \\
                                   & 00110       & \texttt{LD}   \\
                                   & 00111       & \texttt{SD}   \\
        \midrule
        \multirow{4}{*}{Jump}      & 01000       & \texttt{JMP}  \\
                                   & 01001       & \texttt{JEQ}  \\
                                   & 01010       & \texttt{JLT}  \\
                                   & 01011       & \texttt{JGT}  \\
        \midrule
        \multirow{3}{*}{Immediate} & 01100       & \texttt{ADDI} \\
                                   & 01101       & \texttt{SUBI} \\
                                   & 01110       & \texttt{LI}   \\
        \midrule
        \multirow{2}{*}{Runtime}   & 10000       & \texttt{NOP}  \\
                                   & 11111       & \texttt{END}  \\
        \bottomrule
    \end{tabular}
\end{table}
\subsection{Compiled program}
\subsection{CPU block}
\section{Implementation}
\emph{Briefly discuss the implementation in Chisel of your design. You can include some code snippets if these are relevant to explain certain aspects of the implementation. In other words, try to answer the question “What does a reader need to know about your Chisel implementation?”}
\section{Test and analysis}
\emph{Report here the results from the test you have carried out. Present the test you have developed (if any). Remember to discuss the results and the test you have carried out, do not just present them, but explain and argue their meaning. Address the design evaluation questions listed in Task 11 in the Assignment 2 document.}
% \section{References}
\begin{thebibliography}{1}
    \bibitem{arduino}
    Arduino, José Bagur, Taddy Chung \emph{Arduino Memory Guide (19/09/2023)\newline \href{https://docs.arduino.cc/learn/programming/memory-guide}{https://docs.arduino.cc/learn/programming/memory-guide}}
\end{thebibliography}
%Bibliography herunder:
%\newpage

%\bibliographystyle{unsrtnat}
%\bibliography{Bibliography}

%\newpage

%\listoffigures
% \newpage
% \listoftables
%\newpage

%Appendicer herunder:

%\input{Appendix.tex}

\end{document}




ASSEMBLY CODE

1. LOAD R1 <- 0
2. LOAD R2 <- 0
3. ADD R8 = R1 + R2
4. ADD R3 = R8 + 1
5. ADD R4 = R8 + 20
6. ADD R5 = R8 + 22
7. ADD R6 = R8 + 41
8. LOAD R3 R3
9. LOAD R4 R4
10. LOAD R5 R5
11. LOAD R6 R6
12. ADD R3 = R3 + R4
13. ADD R3 = R3 + R5
14. ADD R3 = R3 + R6
15. ADD R7 = 0 + 21
16. STORE R7 <- 255
17. JEQ R3 === 1020 -> 19
18. STORE R7 <- 000
19. ADD R1 = R1 + 1
20. JEQ R1 === 19 -> 22
21. JUMP -> 3
22. ADD R1 = 0 + 0
23. ADD R2 = R2 + 20
24. JEQ R2 === 380 -> 26
25. JUMP -> 3
26. END;l